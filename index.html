<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Swasya | Workforce Management V15</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    
    <style>
        :root {
            --brand-green: #2D5A27;
            --rusty: #8D4B38;
            --gold: #C5A028;
            --pink: #E0899C;
            --sidebar-dark: #1A1C1A;
            --holiday-dark: #222;
        }

        * { box-sizing: border-box; font-family: 'Plus Jakarta Sans', sans-serif; }
        body { margin: 0; background-color: #F8F9FA; display: flex; height: 100vh; overflow: hidden; }

        /* --- LOGIN PAGE --- */
        #login-screen {
            position: fixed; inset: 0; z-index: 9999;
            background: url('https://images.unsplash.com/photo-1447752875215-b2761acb3c5d?auto=format&fit=crop&w=1920&q=80') center/cover no-repeat;
            display: flex; align-items: center; justify-content: center;
        }
        .login-card { 
            background: rgba(255, 255, 255, 0.1); backdrop-filter: blur(35px); 
            padding: 50px; border-radius: 30px; border: 1px solid rgba(255,255,255,0.2); 
            width: 400px; text-align: center; box-shadow: 0 25px 50px rgba(0,0,0,0.3);
        }
        .login-card input { width: 100%; padding: 15px; margin: 10px 0; border-radius: 12px; border: none; background: white; outline: none; }

        /* --- SIDEBAR --- */
        .sidebar { 
            width: 320px; background: var(--sidebar-dark); padding: 40px 25px; 
            display: flex; flex-direction: column; border-right: 1px solid #333;
            overflow-y: auto; scrollbar-width: thin; scrollbar-color: #444 transparent;
        }
        .sidebar::-webkit-scrollbar { width: 6px; }
        .sidebar::-webkit-scrollbar-thumb { background: #444; border-radius: 10px; }
        .logo-container { text-align: center; margin-bottom: 40px; }
        .logo-img { width: 150px; }
        .profile-section { margin-bottom: 25px; border-bottom: 1px solid #333; padding-bottom: 20px; }
        .emp-name { color: white; font-size: 1.2rem; font-weight: 700; margin: 0; }
        .emp-title { color: var(--gold); font-size: 0.75rem; font-weight: 800; text-transform: uppercase; letter-spacing: 1.5px; margin-top: 5px; display: block; }
        
        .side-stats { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 20px; }
        .side-card { background: rgba(255,255,255,0.05); padding: 12px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.1); }
        .side-card-label { color: #AAA; font-size: 0.55rem; display: block; margin-bottom: 4px; font-weight: 700; }
        .side-card-val { color: white; font-size: 1rem; font-weight: 700; }
        .cf-tab { background: rgba(197, 160, 40, 0.1); border: 1px solid var(--gold); margin-bottom: 20px; padding: 12px; border-radius: 12px; }

        /* --- MAIN --- */
        .main { flex: 1; display: flex; flex-direction: column; overflow-y: auto; }
        header { padding: 25px 50px; background: white; border-bottom: 1px solid #EEE; display: flex; justify-content: space-between; align-items: center; }
        .content { padding: 40px 50px; }
        .cal-box { background: white; border-radius: 20px; padding: 30px; border: 1px solid #EEE; box-shadow: 0 10px 30px rgba(0,0,0,0.03); }
        .cal-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 1px; background: #EEE; border-radius: 10px; overflow: hidden; }
        .cal-day { background: #fff; min-height: 110px; padding: 10px; position: relative; }
        .entry { position: relative; font-size: 0.6rem; padding: 5px 8px; border-radius: 4px; margin-top: 4px; color: white; font-weight: 700; }
        .entry-pending { background: #777 !important; border: 1px dashed #fff; opacity: 0.7; }
        .entry-cl { background: var(--brand-green); }
        .entry-sl { background: var(--rusty); }
        .entry-el { background: var(--gold); }
        .entry-hld { background: var(--holiday-dark); }
        .approval-item { background: rgba(255,255,255,0.05); padding: 10px; border-radius: 8px; margin-bottom: 10px; border: 1px solid #333; font-size: 0.7rem; color: #ccc;}
        .app-btn { padding: 4px 8px; border: none; border-radius: 4px; cursor: pointer; font-size: 0.6rem; font-weight: bold; margin-top: 5px; color: white;}
        .logout-btn { background: transparent; border: 1px solid #444; color: #888; padding: 12px; cursor: pointer; border-radius: 8px; width: 100%; margin-top: 20px;}
        .hidden { display: none !important; }
        .btn-primary { padding: 12px 25px; background: var(--brand-green); color: white; border: none; border-radius: 10px; font-weight: 700; cursor: pointer; }
    </style>
</head>
<body>

<div id="login-screen">
    <div class="login-card">
        <img src="Swasya Logo 10.png" style="width: 290px; margin-bottom: 30px;">
        <input type="text" id="username" placeholder="Username">
        <input type="password" id="password" placeholder="Password">
        <button class="btn-primary" style="width:100%; margin-top:15px;" onclick="login()">Enter Your Dashboard</button>
    </div>
</div>

<div class="sidebar hidden" id="sidebar">
    <div class="logo-container"><img src="Swasya Logo 3.png" class="logo-img"></div>
    <div class="profile-section">
        <h2 class="emp-name" id="side-name">...</h2>
        <span class="emp-title" id="side-title">...</span>
    </div>

    <div class="cf-tab">
        <span class="side-card-label" style="color:var(--gold)">CARRY FORWARD (EL)</span>
        <span class="side-card-val" id="stat-cf">0</span>
    </div>

    <div class="side-stats">
        <div class="side-card"><span class="side-card-label">CL LEFT</span><span class="side-card-val" id="stat-cl">6</span></div>
        <div class="side-card"><span class="side-card-label">SL LEFT</span><span class="side-card-val" id="stat-sl">6</span></div>
        <div class="side-card"><span class="side-card-label">EL TOTAL</span><span class="side-card-val" id="stat-el">12</span></div>
        <div class="side-card"><span class="side-card-label">LOP DAYS</span><span class="side-card-val" id="stat-lop" style="color:var(--pink)">0</span></div>
    </div>

    <div id="akshith-approval-zone" class="hidden">
        <p style="color:#555; font-size:0.6rem; font-weight:800; margin-bottom:10px; letter-spacing:1px; border-top:1px solid #333; padding-top:15px;">PENDING APPROVALS</p>
        <div id="pending-list"></div>
    </div>

    <div id="admin-tools" class="hidden">
        <select id="admin-user-filter" onchange="updateUI()" style="width: 100%; background: #222; color: white; border: none; padding: 12px; margin-bottom: 12px; border-radius: 8px;">
            <option value="all">Full Workforce</option>
        </select>
        <button onclick="exportComprehensivePDF()" class="btn-primary" style="font-size: 0.7rem; width:100%; background:var(--rusty);">Download Comprehensive Audit</button>
    </div>

    <button onclick="location.reload()" class="logout-btn">Sign Out</button>
</div>

<div class="main hidden" id="main-area">
    <header><h1>Workforce Command Center</h1>
        <div style="display: flex; gap: 12px;">
            <select id="leave-type"><option value="CL">Casual Leave</option><option value="SL">Sick Leave</option><option value="EL">Earned Leave</option><option value="OFF">Weekly Off</option></select>
            <input type="date" id="leave-date">
            <button onclick="submitLeave()" class="btn-primary">Request Leave</button>
        </div>
    </header>
    <div class="content"><div class="cal-box"><div class="cal-grid" id="calendar"></div></div></div>
</div>

<script>
    const USERS = {
        "akshith": { pw: "swasyaAdmin1", role: "admin", name: "Akshith Shetty", title: "AVP" },
        "nijish": { pw: "swasyaAdmin2", role: "admin", name: "Nijish", title: "Founder" },
        "sharan": { pw: "sharan2026", role: "emp", name: "Sharan Dinesh", title: "Sales Manager", cf: 2 },
        "sandeep": { pw: "sandeep2026", role: "emp", name: "Sandeep PS", title: "Sales Manager", cf: 0 },
        "apeksh": { pw: "apeksh2026", role: "emp", name: "Apeksh", title: "Sales Manager", cf: 0 },
        "hema": { pw: "hema2026", role: "emp", name: "Hema", title: "Sales Manager", cf: 0 },
        "sandhya": { pw: "sandhya2026", role: "emp", name: "Sandhya", title: "CRM", cf: 0 },
        "hoysala": { pw: "hoysala2026", role: "emp", name: "Hoysala", title: "Project Manager Kanakpura", cf: 0 },
        "chethan": { pw: "chetan2026", role: "emp", name: "Chethan", title: "Project Manager Sakleshpur", cf: 0 }
    };

    const HOLIDAYS = {"2026-01-15": "Makara Sankranti", "2026-01-26": "Republic Day", "2026-10-02": "Gandhi Jayanti", "2026-12-25": "Christmas"};
    
    let logs = JSON.parse(localStorage.getItem('swasya_v15_final')) || [];
    let notifications = JSON.parse(localStorage.getItem('swasya_notifs')) || {};
    let session = null;
    let viewDate = new Date();

    function login() {
        const u = document.getElementById('username').value.toLowerCase();
        const p = document.getElementById('password').value;
        if(USERS[u] && USERS[u].pw === p) {
            session = { id: u, ...USERS[u] };
            
            // Check for Rejection Notifications
            if(notifications[u] && notifications[u].length > 0) {
                alert("NOTICE FROM ADMIN:\n\nYour leave requests for the following dates were REJECTED:\n" + notifications[u].join("\n"));
                notifications[u] = []; 
                localStorage.setItem('swasya_notifs', JSON.stringify(notifications));
            }

            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('sidebar').classList.remove('hidden');
            document.getElementById('main-area').classList.remove('hidden');
            document.getElementById('side-name').innerText = session.name;
            document.getElementById('side-title').innerText = session.title;
            
            if(session.id === 'akshith') document.getElementById('akshith-approval-zone').classList.remove('hidden');
            if(session.role === 'admin') {
                document.getElementById('admin-tools').classList.remove('hidden');
                const filter = document.getElementById('admin-user-filter');
                filter.innerHTML = '<option value="all">Full Workforce</option>';
                Object.keys(USERS).forEach(uid => {
                    const opt = document.createElement('option'); opt.value = uid; opt.innerText = USERS[uid].name;
                    filter.appendChild(opt);
                });
            }
            updateUI();
        } else { alert("Access Denied."); }
    }

    function submitLeave() {
        const type = document.getElementById('leave-type').value;
        const dateVal = document.getElementById('leave-date').value;
        if(!dateVal) return;
        
        logs.push({ id: Date.now(), uid: session.id, name: session.name, type: type, date: dateVal, status: 'pending' });
        localStorage.setItem('swasya_v15_final', JSON.stringify(logs));
        alert("Submitted for Akshith's Approval.");
        updateUI();
    }

    function handleApproval(id, action) {
        const log = logs.find(l => l.id === id);
        if(!log) return;

        if(action === 'approve') {
            log.status = 'approved';
        } else {
            // Add to notifications
            if(!notifications[log.uid]) notifications[log.uid] = [];
            notifications[log.uid].push(log.date);
            localStorage.setItem('swasya_notifs', JSON.stringify(notifications));
            logs = logs.filter(l => l.id !== id);
        }
        localStorage.setItem('swasya_v15_final', JSON.stringify(logs));
        updateUI();
    }

    function updateUI() {
        const grid = document.getElementById('calendar'); grid.innerHTML = '';
        const selected = (session.role === 'admin') ? document.getElementById('admin-user-filter').value : session.id;
        const targetUser = (selected === 'all') ? session.id : selected;
        
        // CF Calculation
        const cfBase = USERS[targetUser].cf || 0;
        document.getElementById('stat-cf').innerText = cfBase;

        // Leave Counters
        const userLogs = logs.filter(l => l.uid === targetUser && l.status === 'approved');
        document.getElementById('stat-cl').innerText = 6 - userLogs.filter(l => l.type === 'CL').length;
        document.getElementById('stat-sl').innerText = 6 - userLogs.filter(l => l.type === 'SL').length;
        document.getElementById('stat-el').innerText = (12 + cfBase) - userLogs.filter(l => l.type === 'EL').length;
        document.getElementById('stat-lop').innerText = userLogs.filter(l => l.type === 'LOP' || (l.type === 'CL' && userLogs.filter(x=>x.type==='CL').length > 6)).length;

        // Render Calendar (Simplified)
        for(let d=1; d<=31; d++) {
            const ds = `2026-01-${d.toString().padStart(2,'0')}`;
            let html = `<div class="cal-day"><b>${d}</b>`;
            logs.filter(l => l.date === ds && (selected === 'all' || l.uid === selected)).forEach(l => {
                html += `<div class="entry entry-${l.type.toLowerCase()} ${l.status==='pending'?'entry-pending':''}">${l.name.split(' ')[0]}</div>`;
            });
            grid.innerHTML += html + `</div>`;
        }

        if(session.id === 'akshith') {
            const list = document.getElementById('pending-list'); list.innerHTML = '';
            logs.filter(l => l.status === 'pending').forEach(l => {
                list.innerHTML += `<div class="approval-item">${l.name}: ${l.date}<br>
                <button class="app-btn" style="background:var(--brand-green)" onclick="handleApproval(${l.id}, 'approve')">Approve</button>
                <button class="app-btn" style="background:var(--rusty)" onclick="handleApproval(${l.id}, 'reject')">Reject</button></div>`;
            });
        }
    }

    // Logic for New Year Transition
    function checkAndResetYear() {
        const lastReset = localStorage.getItem('swasya_last_reset');
        const currentYear = new Date().getFullYear();
        if(lastReset && lastReset < currentYear) {
            // Calculate EL Carry Forward
            Object.keys(USERS).forEach(uid => {
                const usedEL = logs.filter(l => l.uid === uid && l.status === 'approved' && l.type === 'EL').length;
                const leftoverEL = (12 + (USERS[uid].cf || 0)) - usedEL;
                USERS[uid].cf = Math.max(0, leftoverEL); // Carry Forward updated
            });
            logs = []; // Reset logs for new year
            localStorage.setItem('swasya_v15_final', JSON.stringify(logs));
            localStorage.setItem('swasya_last_reset', currentYear);
        }
    }
</script>
</body>
</html>