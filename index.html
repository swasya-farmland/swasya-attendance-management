<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Swasya | Workforce Management</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    
    <style>
        :root {
            --brand-green: #2D5A27;
            --brand-light: #4A7c44;
            --rusty: #8D4B38;
            --gold: #C5A028;
            --pink: #E0899C;
            --sidebar-dark: #1A1C1A;
            --holiday-dark: #222;
            --wfh-teal: #008080;
        }

        /* --- PRESERVED PC STYLES --- */
        * { box-sizing: border-box; font-family: 'Plus Jakarta Sans', sans-serif; }
        body { margin: 0; background-color: #F8F9FA; display: flex; height: 100vh; overflow: hidden; }

        #login-screen {
            position: fixed; inset: 0; z-index: 9999;
            background: url('https://images.unsplash.com/photo-1447752875215-b2761acb3c5d?auto=format&fit=crop&w=1920&q=80') center/cover no-repeat;
            display: flex; align-items: center; justify-content: center;
        }
        .login-card { 
            background: rgba(255, 255, 255, 0.1); backdrop-filter: blur(35px); 
            padding: 50px; border-radius: 30px; border: 1px solid rgba(255,255,255,0.2); 
            width: 400px; text-align: center; box-shadow: 0 25px 50px rgba(0,0,0,0.3);
        }
        .login-card input { width: 100%; padding: 15px; margin: 10px 0; border-radius: 12px; border: none; background: white; outline: none; }

        .sidebar { 
            width: 320px; background: var(--sidebar-dark); padding: 40px 25px; 
            display: flex; flex-direction: column; border-right: 1px solid #333;
            overflow-y: auto; scrollbar-width: thin; scrollbar-color: #444 transparent;
        }
        .sidebar::-webkit-scrollbar { width: 6px; }
        .sidebar::-webkit-scrollbar-thumb { background: #444; border-radius: 10px; }

        .logo-container { text-align: center; margin-bottom: 40px; }
        .logo-img { width: 150px; }
        .profile-section { margin-bottom: 30px; border-bottom: 1px solid #333; padding-bottom: 25px; }
        .emp-name { color: white; font-size: 1.2rem; font-weight: 700; margin: 0; }
        .emp-title { color: var(--gold); font-size: 0.75rem; font-weight: 800; text-transform: uppercase; letter-spacing: 1.5px; margin-top: 5px; display: block; }
        
        .side-stats { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 30px; }
        .side-card { background: rgba(255,255,255,0.05); padding: 15px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.1); }
        .side-card-label { color: #AAA; font-size: 0.6rem; display: block; margin-bottom: 4px; }
        .side-card-val { color: white; font-size: 1.1rem; font-weight: 700; }
        .preview-pane { background: rgba(0,0,0,0.3); padding: 15px; border-radius: 12px; border: 1px dashed #444; color: #AAA; font-size: 0.75rem; }

        .main { flex: 1; display: flex; flex-direction: column; overflow-y: auto; }
        header { padding: 25px 50px; background: white; border-bottom: 1px solid #EEE; display: flex; justify-content: space-between; align-items: center; }
        header h1 { margin: 0; font-size: 1.4rem; color: var(--brand-green); font-weight: 800; }

        .content { padding: 40px 50px; }
        .cal-box { background: white; border-radius: 20px; padding: 30px; border: 1px solid #EEE; box-shadow: 0 10px 30px rgba(0,0,0,0.03); }
        .cal-nav { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; }
        .cal-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 1px; background: #EEE; border: 1px solid #EEE; border-radius: 10px; overflow: hidden; }
        .cal-day { background: #fff; min-height: 115px; padding: 10px; position: relative; }
        .cal-head { background: #F8F9FA; padding: 12px; text-align: center; font-size: 0.7rem; font-weight: 800; color: #999; text-transform: uppercase; }
        
        .entry { position: relative; font-size: 0.6rem; padding: 5px 8px; border-radius: 4px; margin-top: 4px; color: white; font-weight: 700; }
        .entry-pending { background: #777 !important; border: 1px dashed #fff; opacity: 0.7; }
        .del-btn { position: absolute; right: 5px; top: 50%; transform: translateY(-50%); cursor: pointer; color: white; font-weight: bold; background: rgba(0,0,0,0.2); width: 14px; height: 14px; display: flex; align-items: center; justify-content: center; border-radius: 50%; font-size: 10px; }

        .entry-cl { background: var(--brand-green); }
        .entry-sl { background: var(--rusty); }
        .entry-el { background: var(--gold); }
        .entry-off { background: #666; }
        .entry-lop { background: var(--pink); }
        .entry-hld { background: var(--holiday-dark); }
        .entry-wfh { background: var(--wfh-teal); }

        .hidden { display: none !important; }
        .btn-primary { padding: 12px 25px; background: var(--brand-green); color: white; border: none; border-radius: 10px; font-weight: 700; cursor: pointer; transition: 0.2s; }
        .logout-btn { background: transparent; border: 1px solid #444; color: #888; padding: 12px; cursor: pointer; border-radius: 8px; font-size: 0.75rem; font-weight: 700; width: 100%; margin-top: 30px; margin-bottom: 20px;}
        
        .approval-item { background: rgba(255,255,255,0.05); padding: 10px; border-radius: 8px; margin-bottom: 10px; border: 1px solid #333; font-size: 0.7rem; color: #ccc;}
        .app-btn { padding: 4px 8px; border: none; border-radius: 4px; cursor: pointer; font-size: 0.6rem; font-weight: bold; margin-top: 5px; }
        .btn-approve { background: var(--brand-green); color: white; margin-right: 5px;}
        .btn-reject { background: var(--rusty); color: white; }

        select, input[type="date"], input[type="text"] { padding: 10px; border-radius: 8px; border: 1.5px solid #EEE; font-weight: 600; }
        .comment-box { width: 200px; display: none; }

        /* --- NEW MOBILE-ONLY OVERRIDES --- */
        @media (max-width: 768px) {
            body { flex-direction: column; overflow: hidden; }
            .sidebar { 
                width: 100%; height: auto; position: fixed; bottom: 0; left: 0; z-index: 1000;
                padding: 10px 15px; flex-direction: row; border-right: none; border-top: 1px solid #333;
                justify-content: space-between; align-items: center; overflow: visible;
            }
            /* Hide non-essential sidebar elements on mobile */
            .logo-container, .profile-section, .side-stats, .preview-pane, .logout-btn, #admin-tools, #akshith-approval-zone p { display: none !important; }
            
            /* Show simplified mobile nav */
            .sidebar::before { content: "Logged in as: " attr(data-user); color: #888; font-size: 0.7rem; font-weight: bold; }
            .sidebar .side-stats-mobile { display: flex; gap: 10px; }

            header { padding: 15px; flex-direction: column; height: auto; align-items: flex-start; }
            header h1 { font-size: 1.1rem; margin-bottom: 10px; }
            header div { width: 100%; display: grid !important; grid-template-columns: 1fr 1fr; gap: 8px; }
            
            .comment-box, .btn-primary { grid-column: span 2; width: 100%; }
            select, input[type="date"], input[type="text"] { width: 100%; font-size: 0.8rem; }

            .content { padding: 10px; padding-bottom: 80px; }
            .cal-box { padding: 15px; border-radius: 12px; }
            
            /* Vertical List for Mobile Calendar */
            .cal-grid { display: block; border: none; background: transparent; }
            .cal-head { display: none; }
            .cal-day { 
                display: flex; align-items: center; min-height: auto; 
                margin-bottom: 5px; padding: 10px; border: 1px solid #EEE; 
                border-radius: 8px; position: relative;
            }
            .cal-day b { width: 30px; font-size: 0.9rem; }
            .cal-day:empty { display: none; }
            .entry { margin-top: 0; margin-left: 5px; font-size: 0.65rem; }
        }
    </style>
</head>
<body id="app-body">

<div id="login-screen">
    <div class="login-card">
        <img src="Swasya Logo 10.png" style="width: 290px; margin-bottom: 30px;">
        <input type="text" id="username" placeholder="Username">
        <input type="password" id="password" placeholder="Password">
        <button class="btn-primary" style="width:100%; margin-top:15px;" onclick="login()">Enter Your Dashboard</button>
    </div>
</div>

<div class="sidebar hidden" id="sidebar">
    <div class="logo-container">
        <img src="Swasya Logo 3.png" class="logo-img">
    </div>
    
    <div class="profile-section">
        <h2 class="emp-name" id="side-name">...</h2>
        <span class="emp-title" id="side-title">...</span>
    </div>

    <div class="side-stats">
        <div class="side-card"><span class="side-card-label">CL LEFT</span><span class="side-card-val" id="stat-cl">6</span></div>
        <div class="side-card"><span class="side-card-label">SL LEFT</span><span class="side-card-val" id="stat-sl">6</span></div>
        <div class="side-card"><span class="side-card-label">EL LEFT</span><span class="side-card-val" id="stat-el">12</span></div>
        <div class="side-card"><span class="side-card-label">LOP DAYS</span><span class="side-card-val" id="stat-lop" style="color:var(--pink)">0</span></div>
    </div>

    <div id="akshith-approval-zone" class="hidden">
        <p style="color:#555; font-size:0.6rem; font-weight:800; margin-bottom:10px; letter-spacing:1px; border-top:1px solid #333; padding-top:15px;">PENDING APPROVALS</p>
        <div id="pending-list"></div>
        
        <div class="side-stats" style="margin-top:20px;">
            <div class="side-card"><span class="side-card-label">PENDING</span><span class="side-card-val" id="stat-pending-count" style="color:var(--gold)">0</span></div>
            <div class="side-card"><span class="side-card-label">APPROVED</span><span class="side-card-val" id="stat-approved-count" style="color:var(--brand-green)">0</span></div>
        </div>
    </div>

    <div id="admin-tools" class="hidden">
        <p style="color:#555; font-size:0.6rem; font-weight:800; margin-bottom:10px; letter-spacing:1px; margin-top:15px;">ADMIN AUDIT PANEL</p>
        <select id="admin-user-filter" onchange="updateUI()" style="width: 100%; background: #222; color: white; border: none; padding: 12px; margin-bottom: 12px; border-radius: 8px;">
            <option value="all">Full Workforce</option>
        </select>
        <button onclick="exportComprehensivePDF()" class="btn-primary" style="font-size: 0.7rem; width:100%; background:var(--rusty); margin-bottom: 20px;">Download Selected Audit</button>
    </div>

    <p style="color:#555; font-size:0.6rem; font-weight:800; margin-bottom:10px; letter-spacing:1px;">POLICY CHECK</p>
    <div class="preview-pane" id="rt-preview">Awaiting date selection...</div>

    <button onclick="location.reload()" class="logout-btn">Sign Out</button>
</div>

<div class="main hidden" id="main-area">
    <header>
        <h1>Workforce Command Center</h1>
        <div style="display: flex; gap: 12px; align-items: center;">
            <select id="leave-type" onchange="handleTypeChange()">
                <option value="CL">Casual Leave</option>
                <option value="SL">Sick Leave</option>
                <option value="EL">Earned Leave</option>
                <option value="WFH">Work From Home</option>
                <option value="OFF">Weekly Off (M-W)</option>
            </select>
            <input type="text" id="wfh-comment" class="comment-box" placeholder="WFH Reason/Comment">
            <input type="date" id="leave-date" onchange="updatePreview()">
            <button onclick="submitLeave()" class="btn-primary">Request</button>
        </div>
    </header>

    <div class="content">
        <div class="cal-box">
            <div class="cal-nav">
                <button onclick="moveMonth(-1)" style="border:none; background:none; cursor:pointer; font-weight:800; padding:10px;">&larr;</button>
                <h2 id="cal-title" style="margin:0; font-size:1.1rem; letter-spacing:2px; text-transform: uppercase;">January 2026</h2>
                <button onclick="moveMonth(1)" style="border:none; background:none; cursor:pointer; font-weight:800; padding:10px;">&rarr;</button>
            </div>
            <div class="cal-grid" id="calendar"></div>
        </div>
    </div>
</div>

<script>
    const USERS = {
        "akshith": { pw: "swasyaAdmin1", role: "admin", name: "Akshith Shetty", title: "AVP" },
        "nijish": { pw: "swasyaAdmin2", role: "admin", name: "Nijish", title: "Founder" },
        "sharan": { pw: "sharan2026", role: "emp", name: "Sharan Dinesh", title: "Sales Manager" },
        "sandeep": { pw: "sandeep2026", role: "emp", name: "Sandeep PS", title: "Sales Manager" },
        "apeksh": { pw: "apeksh2026", role: "emp", name: "Apeksh", title: "Sales Manager" },
        "hema": { pw: "hema2026", role: "emp", name: "Hema", title: "Sales Manager" },
        "sandhya": { pw: "sandhya2026", role: "emp", name: "Sandhya", title: "CRM" }
    };

    const HOLIDAYS = {
        "2026-01-15": "Makara Sankranti", "2026-01-26": "Republic Day",
        "2026-03-19": "Ugadi Festival", "2026-04-14": "Dr. Ambedkar Jayanti",
        "2026-05-01": "Labour Day", "2026-05-28": "Bakrid",
        "2026-08-15": "Independence Day", "2026-08-26": "Eid e Milad",
        "2026-10-02": "Gandhi Jayanti", "2026-10-20": "Ayudha Puja",
        "2026-10-21": "Vijayadashami", "2026-11-10": "Balipadyami",
        "2026-12-25": "Christmas Day", "2026-12-31": "New Year"
    };

    const BASE_LIMITS = { CL: 6, SL: 6, EL: 12 };
    function getUserLimits(uid) {
        let limits = { ...BASE_LIMITS };
        if(uid === 'sharan') limits.EL = 14; 
        if(uid === 'sandeep') limits.EL = 13; 
        return limits;
    }

    let session = null;
    let logs = JSON.parse(localStorage.getItem('swasya_v14_workflow')) || [];
    let viewDate = new Date(2026, 0, 1);

    function login() {
        const u = document.getElementById('username').value.toLowerCase();
        const p = document.getElementById('password').value;
        if(USERS[u] && USERS[u].pw === p) {
            session = { id: u, ...USERS[u] };
            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('sidebar').classList.remove('hidden');
            document.getElementById('main-area').classList.remove('hidden');
            document.getElementById('side-name').innerText = session.name;
            document.getElementById('side-title').innerText = session.title;
            document.getElementById('sidebar').setAttribute('data-user', session.name);

            if(session.id === 'akshith') document.getElementById('akshith-approval-zone').classList.remove('hidden');
            if(session.role === 'admin') {
                document.getElementById('admin-tools').classList.remove('hidden');
                const filter = document.getElementById('admin-user-filter');
                filter.innerHTML = '<option value="all">Full Workforce</option>';
                Object.keys(USERS).forEach(uid => {
                    const opt = document.createElement('option');
                    opt.value = uid; opt.innerText = USERS[uid].name;
                    filter.appendChild(opt);
                });
            }
            updateUI();
        } else { alert("Access Denied."); }
    }

    function handleTypeChange() {
        const type = document.getElementById('leave-type').value;
        const commentBox = document.getElementById('wfh-comment');
        commentBox.style.display = (type === 'WFH') ? 'block' : 'none';
        updatePreview();
    }

    function updatePreview() {
        const type = document.getElementById('leave-type').value;
        const dateVal = document.getElementById('leave-date').value;
        if(!dateVal) return;
        const day = new Date(dateVal).getDay(); 
        const preview = document.getElementById('rt-preview');
        const userLimits = getUserLimits(session.id);
        if(type === 'OFF') {
            if(day >= 1 && day <= 3) preview.innerHTML = `<span style="color:#A8E6CF">✔ Policy Met</span>`;
            else preview.innerHTML = `<span style="color:var(--pink)">✘ Invalid Day</span>`;
        } else if(type === 'WFH') {
            preview.innerHTML = `<span style="color:var(--wfh-teal)">WFH Request Pending</span>`;
        } else {
            const used = logs.filter(l => l.uid === session.id && l.type === type && l.status === 'approved').length;
            preview.innerHTML = `Category: ${type}<br>Remaining: ${Math.max(0, (userLimits[type] || 0) - used)}`;
        }
    }

    function submitLeave() {
        const type = document.getElementById('leave-type').value;
        const dateVal = document.getElementById('leave-date').value;
        const comment = document.getElementById('wfh-comment').value;
        if(!dateVal) return;
        if(type === 'OFF' && (new Date(dateVal).getDay() === 0 || new Date(dateVal).getDay() > 3)) {
            alert("Weekly Offs are strictly Mon-Wed."); return;
        }
        const userLimits = getUserLimits(session.id);
        let finalType = type;
        if (type !== 'WFH' && type !== 'OFF') {
            const approvedCount = logs.filter(l => l.uid === session.id && l.type === type && l.status === 'approved').length;
            if(userLimits[type] && approvedCount >= userLimits[type]) finalType = 'LOP';
        }
        logs.push({ id: Date.now(), uid: session.id, name: session.name, type: finalType, date: dateVal, comment: type === 'WFH' ? comment : '', status: 'pending' });
        localStorage.setItem('swasya_v14_workflow', JSON.stringify(logs));
        alert("Submitted for approval.");
        document.getElementById('wfh-comment').value = '';
        updateUI();
    }

    function handleApproval(id, action) {
        if(action === 'approve') {
            const log = logs.find(l => l.id === id);
            if(log) log.status = 'approved';
        } else { logs = logs.filter(l => l.id !== id); }
        localStorage.setItem('swasya_v14_workflow', JSON.stringify(logs));
        updateUI();
    }

    function deleteLog(id) {
        if(confirm("Permanently remove this log?")) {
            logs = logs.filter(l => l.id !== id);
            localStorage.setItem('swasya_v14_workflow', JSON.stringify(logs));
            updateUI();
        }
    }

    function moveMonth(dir) { viewDate.setMonth(viewDate.getMonth() + dir); updateUI(); }

    function updateUI() {
        const grid = document.getElementById('calendar');
        grid.innerHTML = '';
        const selected = (session.role === 'admin') ? document.getElementById('admin-user-filter').value : session.id;
        const year = viewDate.getFullYear();
        const month = viewDate.getMonth();
        document.getElementById('cal-title').innerText = viewDate.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
        
        ['Mon','Tue','Wed','Thu','Fri','Sat','Sun'].forEach(h => grid.innerHTML += `<div class="cal-head">${h}</div>`);
        
        let first = new Date(year, month, 1).getDay();
        let offset = first === 0 ? 6 : first - 1;
        for(let i=0; i<offset; i++) grid.innerHTML += `<div class="cal-day desktop-only"></div>`;
        
        let daysCount = new Date(year, month + 1, 0).getDate();
        for(let d=1; d<=daysCount; d++) {
            const currentObj = new Date(year, month, d);
            const dateStr = `${year}-${(month+1).toString().padStart(2,'0')}-${d.toString().padStart(2,'0')}`;
            let html = `<div class="cal-day"><b>${d}</b>`;
            if(currentObj.getDay() === 0) html += `<div class="entry entry-wfh" style="font-size: 0.5rem; opacity: 0.8;">WFH</div>`;
            if(HOLIDAYS[dateStr]) html += `<div class="entry entry-hld">${HOLIDAYS[dateStr]}</div>`;
            
            const dayLogs = (selected === 'all') ? logs : logs.filter(l => l.uid === selected);
            dayLogs.filter(l => l.date === dateStr).forEach(l => {
                const statusClass = l.status === 'pending' ? 'entry-pending' : '';
                const delBtn = (session.id === 'akshith') ? `<span class="del-btn" onclick="deleteLog(${l.id})">×</span>` : '';
                html += `<div class="entry entry-${l.type.toLowerCase()} ${statusClass}">
                    ${selected === 'all' ? l.name.split(' ')[0] : l.type} ${l.status === 'pending' ? '(?)' : ''}${delBtn}
                </div>`;
            });
            grid.innerHTML += html + `</div>`;
        }
        
        if(session.id === 'akshith') {
            const pendingContainer = document.getElementById('pending-list');
            const pendingItems = logs.filter(l => l.status === 'pending');
            document.getElementById('stat-pending-count').innerText = pendingItems.length;
            document.getElementById('stat-approved-count').innerText = logs.filter(l => l.status === 'approved').length;
            pendingContainer.innerHTML = '';
            pendingItems.forEach(l => {
                pendingContainer.innerHTML += `<div class="approval-item"><strong>${l.name}</strong><br>${l.date} (${l.type})${l.comment ? `<div style="font-style:italic; color:var(--gold); margin: 3px 0;">"${l.comment}"</div>` : ''}<div><button class="app-btn btn-approve" onclick="handleApproval(${l.id}, 'approve')">Approve</button><button class="app-btn btn-reject" onclick="handleApproval(${l.id}, 'reject')">Reject</button></div></div>`;
            });
        }

        const target = (selected === 'all') ? session.id : selected;
        const userLimits = getUserLimits(target);
        const sLogs = logs.filter(l => l.uid === target && l.status === 'approved');
        document.getElementById('stat-cl').innerText = Math.max(0, userLimits.CL - sLogs.filter(l => l.type === 'CL').length);
        document.getElementById('stat-sl').innerText = Math.max(0, userLimits.SL - sLogs.filter(l => l.type === 'SL').length);
        document.getElementById('stat-el').innerText = Math.max(0, userLimits.EL - sLogs.filter(l => l.type === 'EL').length);
        document.getElementById('stat-lop').innerText = sLogs.filter(l => l.type === 'LOP').length;
    }

    function exportComprehensivePDF() {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        const filterVal = document.getElementById('admin-user-filter').value;
        const userList = (filterVal === 'all') ? Object.keys(USERS) : [filterVal];
        doc.setFontSize(18); doc.setTextColor(45, 90, 39);
        doc.text((filterVal === 'all') ? "SWASYA | ANNUAL AUDIT 2026" : `SWASYA | AUDIT - ${USERS[filterVal].name}`, 14, 20);
        let yPos = 40;
        userList.forEach(uid => {
            const user = USERS[uid]; const userLimits = getUserLimits(uid);
            const userLogs = logs.filter(l => l.uid === uid && l.status === 'approved').sort((a,b) => new Date(a.date) - new Date(b.date));
            const clUsed = userLogs.filter(l => l.type === 'CL').length;
            const slUsed = userLogs.filter(l => l.type === 'SL').length;
            const elUsed = userLogs.filter(l => l.type === 'EL').length;
            const lopCount = userLogs.filter(l => l.type === 'LOP').length;
            if (yPos > 230) { doc.addPage(); yPos = 20; }
            doc.setFontSize(12); doc.setTextColor(0); doc.text(`${user.name} - ${user.title}`, 14, yPos);
            yPos += 5;
            doc.autoTable({ startY: yPos, head: [['CL Rem', 'SL Rem', 'EL Rem', 'LOP']], body: [[userLimits.CL - clUsed, userLimits.SL - slUsed, userLimits.EL - elUsed, lopCount]], theme: 'striped', headStyles: { fillColor: [45, 90, 39] } });
            yPos = doc.lastAutoTable.finalY + 5;
            if(userLogs.length > 0) {
                const logRows = userLogs.map(l => [l.date, l.type, new Date(l.date).toLocaleDateString('en-US', {weekday: 'long'})]);
                doc.autoTable({ startY: yPos, head: [['Date', 'Type', 'Day']], body: logRows, theme: 'grid', headStyles: { fillColor: [141, 75, 56] } });
                yPos = doc.lastAutoTable.finalY + 15;
            } else { yPos += 15; }
        });
        doc.save((filterVal === 'all') ? "Full_Workforce_Audit_2026.pdf" : `Audit_${USERS[filterVal].name}.pdf`);
    }
</script>
</body>
</html>